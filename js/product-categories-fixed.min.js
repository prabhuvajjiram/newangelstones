// Product Categories JavaScript
(function(){
function getBasename(e){return e.split(".").slice(0,-1).join(".");}
function getExtension(e){return e.split(".").pop().toLowerCase();}
function addCacheBuster(e,t){if("MBNA_2025"===t)return e;var n=Date.now();return e.includes("?")?e+"&v="+n:e+"?v="+n;}

document.addEventListener("DOMContentLoaded",function(){
  let e={};
  const t=document.getElementById("product-search-form"),
        n=document.getElementById("product-search");
  
  if(t){
    t.addEventListener("submit",function(e){
      e.preventDefault();
      const t=n.value.trim();
      if(t) handleSearch(t);
    });
  }
  
  if(n){
    n.addEventListener("input",debounce(function(e){
      const t=e.target.value.trim();
      if(t.length>=2){
        handleSearch(t);
      } else if(document.getElementById("search-results")){
        document.getElementById("search-results").innerHTML="";
      }
    },300));
  }

  function o(){
    fetch("get_directory_files.php?directory=products")
      .then(function(e){
        if(!e.ok)throw new Error("Network response was not ok");
        return e.json();
      })
      .then(function(t){
        e=t.success?t.files.reduce(function(e,t){
          e[t]=[];
          return e;
        },{}):{};
        i();
      })
      .catch(function(e){
        console.error("Error loading categories:",e);
      });
  }

  function i(){
    const t=document.querySelector(".product-categories-container");
    if(!t)return;
    t.innerHTML="";
    Object.keys(e).forEach(function(n){
      const o=document.createElement("div");
      o.className="category-item glowing-border";
      o.innerHTML=`
                <a href="#${n.toLowerCase()}-collection" class="category-link">
                    <div class="category-image">
                        <img src="images/products/${n}/${n}.jpg" alt="${n}" loading="lazy" onerror="this.src='images/default-thumbnail.jpg'">
                    </div>
                    <h4>${n.replace(/_/g," ")}</h4>
                    <span class="category-count">Loading...</span>
                </a>
            `;
      t.appendChild(o);
      
      (function(t){
        fetch(`get_directory_files.php?directory=products/${t}`)
          .then(function(e){
            if(!e.ok)throw new Error("Network response was not ok");
            return e.json();
          })
          .then(function(n){
            if(n.success){
              e[t]=n.files;
              const o=document.querySelector(`.category-item a[href="#${t.toLowerCase()}-collection"] .category-count`);
              if(o){
                o.textContent=`${n.files.length} Design${1===n.files.length?"":"s"}`;
              }
            }
          })
          .catch(function(e){
            console.error(`Error loading files for ${t}:`,e);
          });
      })(n);
    });

    document.querySelectorAll(".category-link").forEach(function(t){
      t.addEventListener("click",function(n){
        n.preventDefault();
        const o=this.getAttribute("href").replace("#","").replace("-collection","");
        const i=Object.keys(e).find(function(e){
          return e.toLowerCase()===o.toLowerCase();
        });
        if(i){
          (function(t,n){
            showLoadingIndicator(document.body);
            const o="MBNA_2025"===t?"png":"jpg";
            
            fetch(`get_directory_files.php?directory=products/${t}`)
              .then(function(e){
                if(!e.ok)throw new Error("Network response was not ok");
                return e.json();
              })
              .then(function(e){
                if(e.success){
                  const n=e.files;
                  const i=n.map(function(e){
                    const n=getExtension(e);
                    if("jpg"===n||"jpeg"===n||"png"===n){
                      const n=`images/products/${t}/${e}`;
                      const i=getBasename(e);
                      const a=addCacheBuster(n,t);
                      return{
                        fullPath:a,
                        basename:i,
                        thumbnail:`images/products/${t}/thumbnails/${i}_thumb.${o}`,
                        title:i.replace(/_/g," ")
                      };
                    }
                    return null;
                  }).filter(function(e){
                    return e;
                  });
                  showCategoryModal(t,i);
                } else {
                  console.error("Error loading files:",e.message);
                }
              })
              .catch(function(e){
                console.error("Error:",e);
              })
              .finally(function(){
                if(document.querySelector(".loading-indicator")){
                  document.querySelector(".loading-indicator").remove();
                }
              });
          })(i);
        }
      });
    });
  }

  function a(e){
    return new Promise(function(t,n){
      fetch(`get_directory_files.php?search=${encodeURIComponent(e)}`)
        .then(function(e){
          if(!e.ok)throw new Error("Network response was not ok");
          return e.json();
        })
        .then(function(e){
          t(e);
        })
        .catch(function(e){
          n(e);
        });
    });
  }

  function r(e){
    const t=document.getElementById("search-results");
    if(!t)return;
    
    showLoadingIndicator(t);
    t.innerHTML="";
    
    a(e).then(function(n){
      t.innerHTML="";
      if(!n.success||0===n.results.length){
        t.innerHTML=`<div class="no-results">No results found for "${e}"</div>`;
        document.querySelector(".loading-indicator")?.remove();
        return;
      }

      const o=document.createElement("div");
      o.className="search-results-heading";
      o.innerHTML=`<h3>Search Results for "${e}"</h3>`;
      t.appendChild(o);

      const i=document.createElement("div");
      i.className="search-results-grid";
      
      n.results.forEach(function(e){
        const t=document.createElement("div");
        t.className="search-result-item";
        t.innerHTML=`
                    <div class="search-result-image">
                        <img src="${e.thumbnail||e.url}" alt="${e.title}" loading="lazy" onerror="this.src='images/default-thumbnail.jpg'">
                    </div>
                    <div class="search-result-info">
                        <h4>${e.title}</h4>
                        <p>${e.category}</p>
                    </div>
                `;
        t.addEventListener("click",function(){
          const t=[];
          const n=[];
          n.push(e.url);
          const o={
            fullPath:e.url,
            basename:e.title,
            thumbnail:e.thumbnail||e.url,
            title:e.title
          };
          t.push(o);
          showCategoryModal(e.category,t,e.title);
        });
        i.appendChild(t);
      });
      
      t.appendChild(i);
    }).catch(function(n){
      console.error("Search error:",n);
      t.innerHTML=`<div class="search-error">Error searching for "${e}". Please try again.</div>`;
    }).finally(function(){
      if(document.querySelector(".loading-indicator")){
        document.querySelector(".loading-indicator").remove();
      }
    });
  }

  function s(e,t){
    let n;
    return function(){
      const o=arguments;
      const i=this;
      clearTimeout(n);
      n=setTimeout(function(){
        e.apply(i,o);
      },t);
    };
  }

  function c(e,t,n=null){
    console.log("showCategoryModal called for",e,"with",t.length,"images");
    
    if(document.getElementById("categoryModal")){
      document.getElementById("categoryModal").remove();
    }

    const o=document.createElement("div");
    o.className="modal fade";
    o.id="categoryModal";
    o.setAttribute("tabindex","-1");
    o.setAttribute("aria-labelledby","categoryModalLabel");
    o.setAttribute("aria-hidden","true");
    o.innerHTML=`
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">${"Ready-to-Ship Monuments"===e?"Ready-to-Ship Monuments":e.replace(/_/g," ")} Collection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="category-content">
                        <div class="thumbnails-container">
                            <div class="thumbnails-grid"></div>
                        </div>
                        <div class="main-image-container d-none">
                            <div class="main-image-wrapper">
                                <img src="" alt="" class="main-product-image" />
                                <div class="image-navigation">
                                    <button class="prev-image"><i class="bi bi-chevron-left"></i></button>
                                    <button class="next-image"><i class="bi bi-chevron-right"></i></button>
                                </div>
                            </div>
                            <div class="product-info">
                                <h3 class="product-title"></h3>
                                <p class="product-description">Click for fullscreen view</p>
                                <button class="btn btn-secondary btn-sm back-to-thumbnails">
                                    <i class="bi bi-grid"></i> Back to Gallery
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(o);

    const i=new bootstrap.Modal(document.getElementById("categoryModal"));
    i.show();
    
    document.getElementById("categoryModal").addEventListener("hidden.bs.modal",function(){
      document.body.classList.remove("modal-fullscreen-active");
    });

    const a=document.querySelector(".thumbnails-grid");
    const r=document.querySelector(".main-image-container");
    const s=document.querySelector(".thumbnails-container");
    const c=document.querySelector(".main-product-image");
    const d=document.querySelector(".product-title");
    const l=document.querySelector(".prev-image");
    const m=document.querySelector(".next-image");
    const u=document.querySelector(".back-to-thumbnails");
    
    let h=0;

    function p(o){
      h=o;
      c.src=t[o].fullPath;
      d.textContent=t[o].title;
      l.style.visibility=o>0?"visible":"hidden";
      m.style.visibility=o<t.length-1?"visible":"hidden";
      c.setAttribute("data-index",o);
      c.setAttribute("data-product",t[o].basename);
      
      (function(n){
        console.log("Preloading images around index",n);
        const o=[];
        for(let e=Math.max(0,n-2);e<=Math.min(t.length-1,n+2);e++){
          if(e!==n){
            const n=new Image;
            n.src=t[e].fullPath;
            o.push(n);
          }
        }
        return o;
      })(o);
    }

    a.innerHTML="";
    t.forEach(function(e,o){
      const i=document.createElement("div");
      i.className="thumbnail-item";
      i.innerHTML=`
                <img src="${e.thumbnail||e.fullPath}" alt="${e.title}" class="thumbnail-image" loading="lazy" data-full="${e.fullPath}" data-index="${o}" onerror="this.src='images/default-thumbnail.jpg'">
                <div class="thumbnail-title">${e.title}</div>
            `;
      if(n&&e.title===n){
        i.classList.add("highlighted");
      }
      
      i.addEventListener("click",function(){
        a.querySelectorAll(".thumbnail-item").forEach(function(e){
          e.classList.remove("active");
        });
        i.classList.add("active");
        r.classList.remove("d-none");
        s.classList.add("d-none");
        p(o);
      });
      
      a.appendChild(i);
    });

    u.addEventListener("click",function(){
      r.classList.add("d-none");
      s.classList.remove("d-none");
    });

    c.addEventListener("click",function(){
      const n=parseInt(this.getAttribute("data-index"));
      const o=this.getAttribute("data-product");
      p(n);
      
      (function(n,o,i){
        document.querySelectorAll(".fullscreen-container").forEach(function(e){
          e.remove();
        });

        const a=document.createElement("div");
        a.className="fullscreen-container";
        a.innerHTML=`
            <div class="fullscreen-content">
                <div class="fullscreen-image-container">
                    <img src="${t[i].fullPath}" alt="${o}" class="fullscreen-image">
                </div>
                <div class="fullscreen-controls">
                    <button class="fullscreen-prev"><i class="bi bi-chevron-left"></i></button>
                    <button class="fullscreen-close"><i class="bi bi-x-lg"></i></button>
                    <button class="fullscreen-next"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div class="fullscreen-title">${o}</div>
            </div>
        `;
        document.body.appendChild(a);
        document.body.classList.add("modal-fullscreen-active");

        let r=i;

        function s(){
          const e=document.querySelector(".fullscreen-image");
          const n=document.querySelector(".fullscreen-title");
          e.src=t[r].fullPath;
          n.textContent=t[r].title||t[r].basename;
          document.querySelector(".fullscreen-prev").style.display=r>0?"block":"none";
          document.querySelector(".fullscreen-next").style.display=r<t.length-1?"block":"none";
          e.onload=function(){
            e.classList.add("loaded");
          };
        }

        document.querySelector(".fullscreen-close").addEventListener("click",function(){
          document.querySelector(".fullscreen-container").remove();
          document.body.classList.remove("modal-fullscreen-active");
        });

        document.querySelector(".fullscreen-prev").addEventListener("click",function(){
          if(r>0){
            r--;
            document.querySelector(".fullscreen-image").classList.remove("loaded");
            s();
          }
        });

        document.querySelector(".fullscreen-next").addEventListener("click",function(){
          if(r<t.length-1){
            r++;
            document.querySelector(".fullscreen-image").classList.remove("loaded");
            s();
          }
        });

        document.addEventListener("keydown",function(e){
          if("Escape"===e.key){
            document.querySelector(".fullscreen-container")?.remove();
          } else if("ArrowLeft"===e.key&&r>0){
            r--;
            document.querySelector(".fullscreen-image").classList.remove("loaded");
            s();
          } else if("ArrowRight"===e.key&&r<t.length-1){
            r++;
            document.querySelector(".fullscreen-image").classList.remove("loaded");
            s();
          }
        });

        s();
      })(e,t[n].title||t[n].basename,n);
    });

    l.addEventListener("click",function(){
      if(h>0){
        p(h-1);
      }
    });

    m.addEventListener("click",function(){
      if(h<t.length-1){
        p(h+1);
      }
    });

    if(n){
      t.forEach(function(e,o){
        if(e.title===n){
          a.querySelectorAll(".thumbnail-item")[o].click();
          setTimeout(function(){
            a.querySelectorAll(".thumbnail-item")[o].scrollIntoView({
              behavior:"smooth",
              block:"center"
            });
          },300);
        }
      });
    }

    optimizeModalScroll(document.querySelector(".modal-body"));
    
    if(1===t.length){
      document.querySelector(".image-navigation").style.display="none";
    }
  }

  function d(e,t,n){
    document.querySelectorAll(".fullscreen-container").forEach(function(e){
      e.remove();
    });

    const o=document.createElement("div");
    o.className="fullscreen-container";
    o.innerHTML=`
        <div class="fullscreen-content">
            <div class="fullscreen-image-container">
                <img src="${e}" alt="${t}" class="fullscreen-image">
            </div>
            <div class="fullscreen-controls">
                <button class="fullscreen-prev"><i class="bi bi-chevron-left"></i></button>
                <button class="fullscreen-close"><i class="bi bi-x-lg"></i></button>
                <button class="fullscreen-next"><i class="bi bi-chevron-right"></i></button>
            </div>
            <div class="fullscreen-title">${t}</div>
        </div>
    `;
    document.body.appendChild(o);
    document.body.classList.add("modal-fullscreen-active");
  }

  function l(e){
    const t=document.createElement("div");
    t.className="loading-indicator";
    t.innerHTML='<div class="spinner"></div>';
    e.appendChild(t);
    return t;
  }

  function m(e,t){
    if(!e||!t)return;
    
    const n=new Image;
    n.src=t;
    n.onload=function(){
      e.src=t;
      e.classList.add("loaded");
    };
    n.onerror=function(){
      console.error("Error loading image:",t);
      e.classList.add("error");
    };
  }

  function u(e){
    if(!e)return;
    
    let t=!1;
    const n=function(){
      if(!t){
        requestAnimationFrame(function(){
          e.scrollTop+=1;
          e.scrollTop-=1;
          t=!1;
        });
      }
    };
    
    e.addEventListener("scroll",function(){
      t=!0;
      n();
    });
  }

  // Expose required functions to global scope
  window.getBasename = getBasename;
  window.getExtension = getExtension;
  window.addCacheBuster = addCacheBuster;
  window.handleSearch = r;
  window.showCategoryModal = c;
  window.showLoadingIndicator = l;
  window.lazyLoadImage = m;
  window.optimizeModalScroll = u;
  window.debounce = s;

  // Initialize
  o();
  
  document.addEventListener("click",function(e){
    const t=e.target.closest(".category-link");
    if(t){
      e.preventDefault();
    }
  });

  if("loading" in HTMLImageElement.prototype){
    document.querySelectorAll("img[loading='lazy']").forEach(function(e){
      e.src=e.getAttribute("src");
    });
  } else {
    document.querySelectorAll("img[loading='lazy']").forEach(function(e){
      const t=e.getAttribute("src");
      e.setAttribute("data-src",t);
      e.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E";
      
      new IntersectionObserver(function(t,n){
        t.forEach(function(t){
          if(t.isIntersecting){
            const o=t.target;
            const i=o.getAttribute("data-src");
            o.src=i;
            o.removeAttribute("data-src");
            n.unobserve(o);
          }
        });
      }).observe(e);
    });
  }
});
})();
