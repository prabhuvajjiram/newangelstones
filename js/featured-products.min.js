document.addEventListener("DOMContentLoaded",function(){function e(e,t){return"MBNA_2025"===t?e:e.includes("?")?`${e}&v=${Date.now()}`:`${e}?v=${Date.now()}`}if(!document.getElementById("featured-products-fullscreen-styles")){const e=document.createElement("style");e.id="featured-products-fullscreen-styles",e.textContent=`
            .fullscreen-view {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.9);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .fullscreen-view.show {
                opacity: 1;
            }
            .fullscreen-image-container {
                position: relative;
                width: 90%;
                height: 80%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .fullscreen-image {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
                opacity: 0;
                transition: opacity 0.5s ease;
            }
            .fullscreen-image.loaded {
                opacity: 1;
            }
            .fullscreen-controls {
                position: absolute;
                bottom: 20px;
                left: 0;
                width: 100%;
                display: flex;
                justify-content: center;
                gap: 20px;
            }
            .fullscreen-controls button {
                background-color: rgba(0, 0, 0, 0.6);
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                font-size: 1.5rem;
                padding: 0;
                margin: 0;
            }
            .fullscreen-controls button:hover {
                background-color: rgba(255, 255, 255, 0.2);
                border-color: rgba(255, 255, 255, 0.5);
            }
            .fullscreen-prev, .fullscreen-next {
                display: none;
            }
            .fullscreen-title {
                color: white;
                margin-top: 20px;
                font-size: 1.5rem;
                text-align: center;
                font-family: 'Playfair Display', serif;
                text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            }
            .no-scroll {
                overflow: hidden;
            }
            .loading-indicator {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 50px;
                height: 50px;
            }
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid #fff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `,document.head.appendChild(e)}function t(e,t){let i=e,a=t;const n=a.indexOf("?");n>-1&&(a=a.substring(0,n));const s=[a,a.replace(".jpg",".png"),a.replace(".png",".jpg"),"images/default-thumbnail.jpg"];i.onerror=function(){console.warn(`Image failed to load: ${a}`),o(i,s,1)},i.src=s[0]}function o(e,t,i){i<t.length?(console.log(`Trying alternative path ${i}: ${t[i]}`),e.src=t[i]):console.error("All image alternatives failed")}const i={modal:null,modalTitle:null,modalBody:null,modalContent:null,currentSlide:0,slides:[],category:"",categoryDirectory:"",init(e,t=[],o=""){this.category=e,this.slides=t,this.categoryDirectory=o,this.createModal(),this.modal=document.getElementById("featuredProductModal"),this.modalTitle=document.getElementById("featuredProductModalLabel"),this.modalBody=document.querySelector("#featuredProductModal .modal-body"),this.modalContent=document.querySelector("#featuredProductModal .modal-content"),this.initEvents()},constructImagePath(e){return`${this.categoryDirectory}/${e}`},validateImagePath(e,t){try{return new URL(e,window.location.origin),e}catch(o){return console.error(`Invalid path for ${t}: ${e}`,o),`${this.categoryDirectory}/default.jpg`}},loadImages(){if(this.modalBody.innerHTML="",0===this.slides.length)return void(this.modalBody.innerHTML='<div class="no-images">No images found for this category.</div>');const t=document.createElement("div");t.className="featured-products-container",this.modalBody.appendChild(t);const o=document.createElement("div");o.className="featured-products-thumbnails-container",t.appendChild(o);const i=document.createElement("div");i.className="featured-products-thumbnails",o.appendChild(i);const a=document.createElement("div");a.className="featured-products-main-container d-none",t.appendChild(a);const n=document.createElement("div");n.className="featured-products-main",a.appendChild(n);const s=document.createElement("div");s.className="featured-products-info",a.appendChild(s);const d=document.createElement("div");d.className="featured-products-navigation",n.appendChild(d);const r=document.createElement("button");r.className="featured-products-prev",r.innerHTML='<i class="bi bi-chevron-left"></i>',d.appendChild(r);const l=document.createElement("button");l.className="featured-products-next",l.innerHTML='<i class="bi bi-chevron-right"></i>',d.appendChild(l);const c=document.createElement("div");c.className="featured-products-image-container",n.appendChild(c);const m=document.createElement("img");m.className="featured-products-main-image",m.alt="Featured product",c.appendChild(m);const u=document.createElement("h3");u.className="featured-products-title",s.appendChild(u);const p=document.createElement("p");p.className="featured-products-description",p.textContent="Click image for fullscreen view",s.appendChild(p);const h=document.createElement("button");h.className="btn btn-secondary btn-sm back-to-thumbnails",h.innerHTML='<i class="bi bi-grid"></i> Back to Gallery',s.appendChild(h),this.slides.forEach((t,o)=>{const a=document.createElement("div");a.className="featured-product-thumbnail",a.setAttribute("data-index",o);const n=document.createElement("img");n.src=t.thumbnail||t.path,n.className="thumbnail-image",n.alt=t.title||`Product ${o+1}`,n.setAttribute("loading","lazy"),n.onerror=function(){this.src="images/default-thumbnail.jpg"};const s=document.createElement("div");s.className="thumbnail-title",s.textContent=t.title||`Product ${o+1}`,a.appendChild(n),a.appendChild(s),a.addEventListener("click",()=>{document.querySelectorAll(".featured-product-thumbnail").forEach(e=>e.classList.remove("active")),a.classList.add("active"),o.classList.add("d-none"),a.classList.remove("d-none"),this.showSlide(o)}),i.appendChild(a)}),h.addEventListener("click",()=>{a.classList.add("d-none"),o.classList.remove("d-none")}),m.addEventListener("click",()=>{this.openFullscreen(this.currentSlide)}),r.addEventListener("click",()=>{this.showPrevSlide()}),l.addEventListener("click",()=>{this.showNextSlide()})},fetchImages(e){console.log(`Fetching images for ${e}`),fetch(`get_directory_files.php?directory=products/${e}`).then(e=>e.json()).then(t=>{if(t.success){const o=t.files.filter(e=>{const t=e.toLowerCase();return t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".png")}),i=o.map(t=>{const i=`images/products/${e}/${t}`,a=t.split(".")[0].replace(/_/g," "),n=`images/products/${e}/thumbnails/${t.split(".")[0]}_thumb.${"MBNA_2025"===e?"png":"jpg"}`;return{path:this.validateImagePath(i,t),title:a,thumbnail:n}});this.slides=i,this.loadImages()}else console.error("Error fetching images:",t.message)}).catch(e=>{console.error("Fetch error:",e)})},setupEventListeners(){document.querySelectorAll(".featured-product-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.getAttribute("data-category");this.openCategory(o)})})},openCategory(e){this.category=e,this.categoryDirectory=`images/products/${e}`,this.modalTitle.textContent="Ready-to-Ship Monuments"===e?"Ready-to-Ship Monuments":`${e.replace(/_/g," ")} Collection`,this.modal.classList.add("loading"),this.modalBody.innerHTML='<div class="loading-spinner"></div>',this.fetchImages(e);const t=new bootstrap.Modal(this.modal);t.show(),this.modal.addEventListener("hidden.bs.modal",function(){document.body.classList.remove("modal-open")})},showSlide(e){if(this.currentSlide=e,this.slides.length<=e)return;const t=this.slides[e],o=document.querySelector(".featured-products-main-image"),i=document.querySelector(".featured-products-title"),a=document.querySelector(".featured-products-thumbnails-container"),n=document.querySelector(".featured-products-main-container"),s=document.querySelector(".featured-products-prev"),d=document.querySelector(".featured-products-next");o.src=t.path,i.textContent=t.title,a.classList.add("d-none"),n.classList.remove("d-none"),s.style.display=e>0?"block":"none",d.style.display=e<this.slides.length-1?"block":"none",o.onerror=function(){this.src="images/default-thumbnail.jpg"}},showPrevSlide(){this.currentSlide>0&&this.showSlide(this.currentSlide-1)},showNextSlide(){this.currentSlide<this.slides.length-1&&this.showSlide(this.currentSlide+1)},closeModal(){const e=bootstrap.Modal.getInstance(this.modal);e&&e.hide()},openFullscreen(t){const o=this.slides[t];if(!o)return;document.querySelectorAll(".fullscreen-view").forEach(e=>e.remove());const i=document.createElement("div");i.className="fullscreen-view",document.body.appendChild(i);const a=document.createElement("div");a.className="fullscreen-image-container",i.appendChild(a);const n=document.createElement("div");n.className="loading-indicator",n.innerHTML='<div class="spinner"></div>',a.appendChild(n);const s=document.createElement("img");s.className="fullscreen-image",s.alt=o.title,a.appendChild(s);const d=document.createElement("div");d.className="fullscreen-controls",i.appendChild(d);const r=document.createElement("button");r.className="fullscreen-prev",r.innerHTML='<i class="bi bi-chevron-left"></i>',r.style.display=t>0?"block":"none",d.appendChild(r);const l=document.createElement("button");l.className="fullscreen-close",l.innerHTML='<i class="bi bi-x-lg"></i>',d.appendChild(l);const c=document.createElement("button");c.className="fullscreen-next",c.innerHTML='<i class="bi bi-chevron-right"></i>',c.style.display=t<this.slides.length-1?"block":"none",d.appendChild(c);const m=document.createElement("div");m.className="fullscreen-title",m.textContent=o.title,i.appendChild(m),setTimeout(()=>{i.classList.add("show")},10),s.onload=function(){this.classList.add("loaded"),n.remove()},s.src=e(o.path,this.category),document.body.classList.add("no-scroll");let u=t;r.addEventListener("click",()=>{u>0&&(u--,s.classList.remove("loaded"),n.innerHTML='<div class="spinner"></div>',a.appendChild(n),s.src=e(this.slides[u].path,this.category),m.textContent=this.slides[u].title,r.style.display=u>0?"block":"none",c.style.display=u<this.slides.length-1?"block":"none")}),c.addEventListener("click",()=>{u<this.slides.length-1&&(u++,s.classList.remove("loaded"),n.innerHTML='<div class="spinner"></div>',a.appendChild(n),s.src=e(this.slides[u].path,this.category),m.textContent=this.slides[u].title,r.style.display=u>0?"block":"none",c.style.display=u<this.slides.length-1?"block":"none")}),l.addEventListener("click",()=>{i.classList.remove("show"),setTimeout(()=>{i.remove(),document.body.classList.remove("no-scroll")},300)}),document.addEventListener("keydown",t=>{i.contains(document.activeElement)&&("Escape"===t.key?l.click():"ArrowLeft"===t.key?r.click():"ArrowRight"===t.key&&c.click())})},openFullscreenView(e){document.querySelectorAll(".fullscreen-view").forEach(e=>e.remove());const t=document.createElement("div");t.className="fullscreen-view",t.innerHTML=`
                <div class="fullscreen-image-container">
                    <div class="loading-indicator"><div class="spinner"></div></div>
                    <img class="fullscreen-image" src="${e}" alt="Fullscreen view">
                </div>
                <div class="fullscreen-controls">
                    <button class="fullscreen-close"><i class="bi bi-x-lg"></i></button>
                </div>
            `,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10);const o=t.querySelector(".fullscreen-image"),i=t.querySelector(".loading-indicator");o.onload=function(){this.classList.add("loaded"),i&&i.remove()},document.body.classList.add("no-scroll"),t.querySelector(".fullscreen-close").addEventListener("click",function(){t.classList.remove("show"),setTimeout(()=>{t.remove(),document.body.classList.remove("no-scroll")},300)}),document.addEventListener("keydown",function(e){"Escape"===e.key&&t.contains(document.activeElement)&&t.querySelector(".fullscreen-close").click()})},initEvents(){this.setupEventListeners();const e=document.getElementById("featuredProductSearch");e&&e.addEventListener("input",function(e){const t=e.target.value.trim();t.length>=2?i.handleSearch(t):document.getElementById("featuredProductResults")&&(document.getElementById("featuredProductResults").innerHTML="")});const t=document.getElementById("featuredProductSearchForm");t&&t.addEventListener("submit",function(t){t.preventDefault();const o=e.value.trim();o&&i.handleSearch(o)})},handleSearch(e){const t=document.getElementById("featuredProductResults");t&&(t.innerHTML='<div class="loading-spinner"></div>',fetch(`get_directory_files.php?search=${encodeURIComponent(e)}`).then(e=>e.json()).then(e=>{e.success?this.displaySearchResults(e.results):this.displayNoResults()}).catch(e=>{console.error("Search error:",e),t.innerHTML='<div class="search-error">Error during search. Please try again.</div>'}))},filterImagesByQuery(e){return this.slides.filter(t=>t.title.toLowerCase().includes(e.toLowerCase()))},displaySearchResults(e){const t=document.getElementById("featuredProductResults");if(!t)return;if(t.innerHTML="",0===e.length)return void(t.innerHTML=`<div class="no-results">No results found.</div>`);const o=document.createElement("div");o.className="search-results-grid",t.appendChild(o),e.forEach((e,t)=>{const i=document.createElement("div");i.className="search-result-item",i.setAttribute("data-index",t);const a=document.createElement("img");a.className="search-result-image",a.alt=e.title,a.setAttribute("loading","lazy"),a.src=e.thumbnail||e.url,a.onerror=function(){this.src="images/default-thumbnail.jpg"};const n=document.createElement("div");n.className="search-result-title",n.textContent=e.title;const s=document.createElement("div");s.className="search-result-category",s.textContent=e.category,i.appendChild(a),i.appendChild(n),i.appendChild(s),i.addEventListener("click",()=>{this.loadSearchResultImage(t)}),o.appendChild(i)})},loadSearchResultImage(t){const o=document.getElementById("featuredProductResults");if(!o)return;const i=o.querySelectorAll(".search-result-item"),a=i[t].querySelector(".search-result-title").textContent,n=i[t].querySelector(".search-result-category").textContent,s=i[t].querySelector(".search-result-image").getAttribute("data-full")||i[t].querySelector(".search-result-image").src;if(o.innerHTML="",!s)return void(o.innerHTML='<div class="error">Image not found.</div>');const d=document.createElement("div");d.className="search-result-detail";const r=document.createElement("div");r.className="search-result-detail-image-container";const l=document.createElement("img");l.className="search-result-detail-image",l.alt=a,e(s,n),r.appendChild(l);const c=document.createElement("div");c.className="search-result-detail-info";const m=document.createElement("h3");m.textContent=a;const u=document.createElement("p");u.textContent=n;const p=document.createElement("button");p.className="btn btn-primary btn-sm view-fullscreen",p.textContent="View Fullscreen",p.addEventListener("click",()=>{this.openFullscreenView(e(s,n))});const h=document.createElement("button");h.className="btn btn-secondary btn-sm back-to-results",h.textContent="Back to Results",h.addEventListener("click",()=>{this.handleSearch(document.getElementById("featuredProductSearch").value)}),c.appendChild(m),c.appendChild(u),c.appendChild(p),c.appendChild(h),d.appendChild(r),d.appendChild(c),o.appendChild(d),l.src=e(s,n)},displayNoResults(){const e=document.getElementById("featuredProductResults");e&&(e.innerHTML='<div class="no-results">No results found.</div>')},createModal(){document.getElementById("featuredProductModal")||document.body.insertAdjacentHTML("beforeend",`
                <div class="modal fade" id="featuredProductModal" tabindex="-1" aria-labelledby="featuredProductModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="featuredProductModalLabel">Featured Products</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body"></div>
                        </div>
                    </div>
                </div>
            `)}};i.init("",[],"");const a=document.querySelectorAll(".featured-product-gallery");a.length>0&&a.forEach(e=>{const t=e.getAttribute("data-category");if(t){const o=document.createElement("div");o.className="featured-product-gallery-header";const a=document.createElement("h3");a.textContent=t.replace(/_/g," "),o.appendChild(a),e.appendChild(o);const n=document.createElement("div");n.className="featured-product-gallery-content",e.appendChild(n);const s=document.createElement("div");s.className="featured-product-gallery-loading",s.innerHTML='<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>',n.appendChild(s),fetch(`get_directory_files.php?directory=products/${t}`).then(e=>e.json()).then(o=>{if(s.remove(),o.success){const i=o.files.filter(e=>{const t=e.toLowerCase();return t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".png")}).slice(0,4);if(0===i.length)return void(n.innerHTML='<div class="no-images">No images available</div>');const a=document.createElement("div");a.className="featured-product-gallery-grid",n.appendChild(a),i.forEach(o=>{const i=document.createElement("div");i.className="featured-product-gallery-item";const n=document.createElement("img");n.loading="lazy";const s=`images/products/${t}/${o}`,d=e(s,t);n.src=`images/products/${t}/thumbnails/${o.split(".")[0]}_thumb.${"MBNA_2025"===t?"png":"jpg"}`,n.alt=o.split(".")[0].replace(/_/g," "),n.onerror=function(){this.src="images/default-thumbnail.jpg"};const r=document.createElement("div");r.className="featured-product-gallery-title",r.textContent=o.split(".")[0].replace(/_/g," "),i.appendChild(n),i.appendChild(r),i.addEventListener("click",()=>{i.init(t),i.openCategory(t)}),a.appendChild(i)});const r=document.createElement("div");r.className="featured-product-gallery-view-all",r.innerHTML=`<a href="#" class="btn btn-outline-primary btn-sm view-all-link" data-category="${t}">View All</a>`,n.appendChild(r),r.querySelector(".view-all-link").addEventListener("click",e=>{e.preventDefault(),i.init(t),i.openCategory(t)})}else n.innerHTML='<div class="error">Error loading gallery</div>'}).catch(e=>{s.remove(),console.error("Gallery fetch error:",e),n.innerHTML='<div class="error">Error loading gallery</div>'})}}),document.querySelectorAll(".open-featured-product").forEach(e=>{e.addEventListener("click",o=>{o.preventDefault();const a=e.getAttribute("data-category");a&&(i.init(a),i.openCategory(a))})})});
